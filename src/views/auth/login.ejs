<section class="auth-layout">
  <div class="auth-hero">
    <img class="hero-logo" src="https://cdn.builder.io/api/v1/image/assets%2Fa5647e4ccf094d4d939a079b9f892c1c%2F240094ac7d6b4725b685503d97c9d9a3?format=webp&width=96" alt="FreshBasket logo" />
    <h2 class="hero-heading">Welcome back</h2>
    <p class="hero-sub">Sign in to manage orders, riders and deliveries.</p>
    <ul class="hero-points">
      <li>Secure account access</li>
      <li>Real-time dashboards</li>
      <li>Faster operations</li>
    </ul>
  </div>

  <div class="auth-panel auth-panel-card">
    <h2 class="auth-title">Sign in to FreshBasket</h2>
    <div id="auth-error" class="auth-error hidden"></div>
    <div id="auth-success" class="auth-success hidden"></div>
    <form id="loginForm" class="auth-form">
      <label class="auth-label">Email
        <input class="auth-input" id="email" type="email" autocomplete="email" required />
      </label>
      <label class="auth-label">Password
        <span class="password-field">
          <input class="auth-input" id="password" type="password" autocomplete="current-password" required />
          <button type="button" id="togglePwd" class="toggle-password" aria-label="Show password">
            <svg class="icon-eye" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/></svg>
            <svg class="icon-eye-off hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.8 21.8 0 0 1 5.06-6.94M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a21.76 21.76 0 0 1-3.2 4.2M3 3l18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </span>
      </label>
      <div class="auth-actions">
        <label class="remember">
          <input type="checkbox" id="rememberMe" /> Remember me
        </label>
        <button class="link-button" id="forgotBtn" type="button">Forgot password?</button>
      </div>
      <button class="auth-button auth-button-wide" id="submitBtn" type="submit">Sign in</button>
    </form>
    <p class="auth-alt">No account? <a href="/auth/register">Register</a></p>
  </div>
</section>
<script type="module">
  const cfg = <%- JSON.stringify(firebaseConfig) %>;
  const errBox = document.getElementById('auth-error');
  const okBox = document.getElementById('auth-success');
  const submitBtn = document.getElementById('submitBtn');
  function mapError(e){
    const code = (e && e.code) || '';
    if(code.includes('invalid-email')) return 'Please enter a valid email address.';
    if(code.includes('user-not-found')) return 'No account found with that email.';
    if(code.includes('wrong-password')) return 'Incorrect password. Try again.';
    if(code.includes('too-many-requests')) return 'Too many attempts. Please wait and try again.';
    if(code.includes('network-request-failed')) return 'Network error. Check your connection and try again.';
    return (e && (e.message || e.code)) || 'Something went wrong.';
  }
  function showErr(msg){ errBox.textContent = msg; errBox.classList.remove('hidden'); }
  function showOk(msg){ okBox.textContent = msg; okBox.classList.remove('hidden'); }
  function clearMsgs(){ errBox.classList.add('hidden'); okBox.classList.add('hidden'); }
  if(!cfg || !cfg.apiKey){ showErr('Firebase not configured. Set env vars.'); }
  else {
    import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js').then(({initializeApp})=>{
      return Promise.all([
        Promise.resolve(initializeApp(cfg)),
        import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js')
      ]);
    }).then(([app, authMod])=>{
      const { getAuth, setPersistence, browserLocalPersistence, browserSessionPersistence, signInWithEmailAndPassword, sendPasswordResetEmail } = authMod;
      const auth = getAuth();

      document.getElementById('togglePwd').addEventListener('click', ()=>{
        const i = document.getElementById('password');
        const btn = document.getElementById('togglePwd');
        const eye = btn.querySelector('.icon-eye');
        const eyeOff = btn.querySelector('.icon-eye-off');
        if(i.type === 'password'){
          i.type='text'; btn.setAttribute('aria-label','Hide password'); eye.classList.add('hidden'); eyeOff.classList.remove('hidden');
        } else {
          i.type='password'; btn.setAttribute('aria-label','Show password'); eye.classList.remove('hidden'); eyeOff.classList.add('hidden');
        }
      });

      document.getElementById('forgotBtn').addEventListener('click', async ()=>{
        clearMsgs();
        const email = document.getElementById('email').value.trim();
        if(!email) return showErr('Enter your email first');
        try { await sendPasswordResetEmail(auth, email); showOk('Password reset email sent'); }
        catch(e){ showErr(mapError(e)); }
      });

      document.getElementById('loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); clearMsgs(); submitBtn.disabled = true; submitBtn.textContent = 'Signing in...';
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;
        try {
          await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);
          const cred = await signInWithEmailAndPassword(auth, email, password);
          const idToken = await cred.user.getIdToken();
          const res = await fetch('/auth/session', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ idToken }) });
          if (!res.ok) throw new Error('Session creation failed');
          showOk('Signed in successfully. Redirecting...');
          setTimeout(()=> window.location.href = '/dashboard', 600);
        } catch (e) { showErr(mapError(e)); }
        finally { submitBtn.disabled = false; submitBtn.textContent = 'Sign in'; }
      });
    }).catch(()=>showErr('Failed to load Firebase.'));
  }
</script>
