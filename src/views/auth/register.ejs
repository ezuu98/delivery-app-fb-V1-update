<section class="auth-panel">
  <h2 class="auth-title">Register</h2>
  <div id="auth-error" class="auth-error" style="display:none"></div>
  <form id="registerForm" class="auth-form">
    <label class="auth-label">Email
      <input class="auth-input" id="email" type="email" required />
    </label>
    <label class="auth-label">Password
      <input class="auth-input" id="password" type="password" minlength="6" required />
    </label>
    <button class="auth-button" type="submit">Create account</button>
  </form>
  <p class="auth-alt">Have an account? <a href="/auth/login">Login</a></p>
</section>
<script type="module">
  const cfg = <%- JSON.stringify(firebaseConfig) %>;
  const errBox = document.getElementById('auth-error');
  function showErr(msg){ errBox.textContent = msg; errBox.style.display='block'; }
  if(!cfg || !cfg.apiKey){ showErr('Firebase not configured. Set env vars.'); }
  else {
    import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js').then(({initializeApp})=>{
      return Promise.all([
        Promise.resolve(initializeApp(cfg)),
        import('https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js')
      ]);
    }).then(([app, authMod])=>{
      const { getAuth, createUserWithEmailAndPassword } = authMod;
      const auth = getAuth();
      document.getElementById('registerForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); errBox.style.display='none';
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          const idToken = await cred.user.getIdToken();
          const res = await fetch('/auth/session', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idToken }) });
          if (!res.ok) throw new Error('Session creation failed');
          window.location.href = '/dashboard';
        } catch (e) { showErr((e && (e.code || e.message)) || 'Registration failed'); }
      });
    }).catch(()=>showErr('Failed to load Firebase.'));
  }
</script>
